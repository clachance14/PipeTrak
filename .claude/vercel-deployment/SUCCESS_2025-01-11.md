# Vercel Deployment Success Configuration - January 11, 2025

## Overview

This document captures the exact working configuration that resolved critical Vercel deployment issues, specifically PostgreSQL prepared statement errors and organization routing 404s. This serves as a reference point for troubleshooting future deployment issues.

## Issues Resolved

### 1. Prisma Prepared Statement Errors
**Symptoms**: 
- PostgreSQL errors: "prepared statement 's0' already exists"
- Better-auth internal server errors
- Session retrieval failures

**Root Cause**: Prisma not handling connection pooling properly in Vercel's serverless environment where connections are reused across function invocations.

### 2. Organization Routing 404 Errors  
**Symptoms**:
- Users redirected to `/app/ics-inc` returning 404
- Database connection failures preventing proper redirects

**Root Cause**: Redirect logic failing when database connections had issues, preventing fallback to PipeTrak routes.

## Working Configuration

### Prisma Client Configuration
**File**: `packages/database/prisma/client.ts`

```typescript
const prismaClientSingleton = () => {
	// Build connection URL with pool configuration
	// Support both DATABASE_URL (dev) and POSTGRES_URL (Vercel production)
	const baseUrl = process.env.DATABASE_URL || process.env.POSTGRES_URL || "";
	
	// For Vercel/serverless environments, use pgbouncer mode to handle prepared statements
	const isServerless = process.env.VERCEL || process.env.AWS_LAMBDA_FUNCTION_NAME;
	const poolParams = isServerless 
		? "?pgbouncer=true&connection_limit=1&pool_timeout=20"
		: "?connection_limit=50&pool_timeout=60";
		
	const urlWithPool = baseUrl.includes("?")
		? `${baseUrl}&${poolParams.substring(1)}`
		: `${baseUrl}${poolParams}`;

	return new PrismaClient({
		log:
			process.env.NODE_ENV === "development"
				? ["error", "warn"]
				: ["error"],
		datasources: {
			db: {
				url: urlWithPool,
			},
		},
	});
};
```

**Key Changes**:
- Automatic serverless detection using `VERCEL` environment variable
- pgbouncer mode enabled for serverless (`pgbouncer=true`)
- Reduced connection limits for serverless (`connection_limit=1`)
- Shorter timeouts for serverless (`pool_timeout=20`)

### Better-Auth Configuration
**File**: `packages/auth/auth.ts`

```typescript
database: prismaAdapter(db, {
	provider: "postgresql",
	// Optimize for serverless environments
	...(process.env.VERCEL && {
		skipPreparedStatements: true,
	}),
}),
```

**Key Changes**:
- Added `skipPreparedStatements: true` for Vercel environment
- Prevents prepared statement conflicts in serverless functions

### Vercel Configuration
**File**: `apps/web/vercel.json`

```json
{
	"version": 2,
	"framework": "nextjs",
	"installCommand": "pnpm install --frozen-lockfile",
	"buildCommand": "pnpm run build",
	"functions": {
		"app/api/**/*.js": {
			"maxDuration": 30
		}
	},
	"env": {
		"PRISMA_GENERATE_SKIP_AUTOINSTALL": "true"
	}
}
```

**Key Changes**:
- Added function duration limits
- Disabled Prisma auto-install to avoid conflicts

### Organization Routing Fix
**File**: `apps/web/app/(saas)/app/(organizations)/[organizationSlug]/page.tsx`

```typescript
export default async function OrganizationPage({
	params,
}: {
	params: Promise<{ organizationSlug: string }>;
}) {
	const { organizationSlug } = await params;

	try {
		const activeOrganization = await getActiveOrganization(
			organizationSlug as string,
		);

		if (!activeOrganization) {
			return notFound();
		}

		redirect(`/app/${organizationSlug}/pipetrak`);
	} catch (error) {
		console.error("Error loading organization:", error);
		// If there's a database error, still try to redirect to pipetrak
		redirect(`/app/${organizationSlug}/pipetrak`);
	}
}
```

**Key Changes**:
- Added try/catch around organization loading
- Fallback redirect to PipeTrak even if database fails
- Prevents 404 errors during temporary database issues

## Environment Variables Required

### Production Environment (Vercel)
```bash
# Database - Vercel provides POSTGRES_URL automatically for Supabase
POSTGRES_URL=postgresql://user:pass@host:5432/db?pgbouncer=true

# Auth
BETTER_AUTH_SECRET=production-secret-here
NEXT_PUBLIC_SITE_URL=https://pipe-trak.vercel.app

# Vercel automatically sets these
VERCEL=1
VERCEL_ENV=production
NODE_ENV=production
```

### Development Environment
```bash
# Database - Standard connection
DATABASE_URL=postgresql://user:pass@localhost:5432/pipetrak_dev

# Auth
BETTER_AUTH_SECRET=dev-secret
NEXT_PUBLIC_SITE_URL=http://localhost:3000

# Development flags
NODE_ENV=development
```

## Verification Steps

### 1. Test Database Connection
```bash
# Should succeed without prepared statement errors
curl -I https://your-deployment.vercel.app/api/auth/session
```

### 2. Test Organization Routing
```bash
# Should redirect properly without 404
curl -I https://your-deployment.vercel.app/app/ics-inc
```

### 3. Test Authentication Flow
1. Navigate to `/auth/login`
2. Complete login
3. Verify redirect to `/app/{org-slug}/pipetrak`
4. Confirm no prepared statement errors in logs

## Troubleshooting

### If Prepared Statement Errors Return
1. Verify `VERCEL` environment variable is set
2. Check connection string includes `pgbouncer=true`
3. Ensure `skipPreparedStatements: true` in auth config
4. Review Vercel function logs for connection patterns

### If Routing 404s Return
1. Check organization data exists in database
2. Verify organization slug is valid
3. Test fallback redirect logic
4. Review server logs for database connection errors

## Linear Integration

### Related Issues
- **Knowledge Base**: Create issue with labels `Knowledge-Base`, `DevOps`, `Documentation`
- **Project**: Database Optimization (`7f5f47e5-a85e-4423-a0d2-b1d7e320d82a`)
- **Team**: PipeTrak (`173da0c8-0e1e-4a5d-94b3-84d02bfbe593`)

### MCP Commands for Issue Creation
```
mcp__linear__create_issue(
  title: "Vercel Deployment Success - Working Configuration Snapshot",
  team: "PipeTrak",
  description: "Documents the working configuration that resolved Prisma prepared statement errors and routing issues on January 11, 2025",
  project: "Database Optimization",
  labels: ["Knowledge-Base", "DevOps", "Documentation", "Backend"]
)
```

## Commit Reference
- **Commit**: `bbb2731c` - "Fix Vercel deployment Prisma prepared statement errors and routing issues"
- **Date**: January 11, 2025
- **Branch**: `main`

## Success Metrics
- ✅ Zero prepared statement errors in production logs
- ✅ Successful user authentication flow
- ✅ Proper organization routing redirects  
- ✅ All API endpoints responding correctly
- ✅ Database connections stable under load

---

*This configuration has been tested and verified working on Vercel production deployment as of January 11, 2025.*