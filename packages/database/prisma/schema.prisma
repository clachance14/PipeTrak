datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

generator client {
    provider        = "prisma-client-js"
    output          = "./generated/client"
    engineType      = "library"
    binaryTargets   = ["native", "rhel-openssl-3.0.x"]
}

generator zod {
    provider         = "zod-prisma-types"
    output           = "./zod"
    createInputTypes = true
    addIncludeType   = false
    addSelectType    = false
}

generator json {
    provider = "prisma-json-types-generator"
}

model User {
    id                 String       @id @default(cuid())
    name               String
    email              String
    emailVerified      Boolean
    image              String?
    createdAt          DateTime
    updatedAt          DateTime
    username           String?
    role               String?
    banned             Boolean?
    banReason          String?
    banExpires         DateTime?
    onboardingComplete Boolean      @default(false)
    paymentsCustomerId String?
    locale             String?
    twoFactorEnabled   Boolean?
    sessions           Session[]
    accounts           Account[]
    passkeys           Passkey[]
    invitations        Invitation[]
    purchases          Purchase[]
    members            Member[]
    twofactors         TwoFactor[]
    aiChats            AiChat[]
    
    // PipeTrak relations
    createdProjects    Project[]    @relation("ProjectCreator")
    installedComponents Component[] @relation("ComponentInstaller")
    completedMilestones ComponentMilestone[] @relation("MilestoneCompleter")
    importJobs         ImportJob[]  @relation("ImportJobUser")
    auditLogs          AuditLog[]   @relation("AuditLogUser")
    
    // Reporting relations
    reportingCacheCreated ReportingCache[] @relation("CacheCreator")
    rocConfigsCreated     ROCConfigurations[] @relation("ROCConfigCreator")
    snapshotsGenerated    ProgressSnapshots[] @relation("SnapshotGenerator")
    reportGenerationsRequested ReportGenerations[] @relation("ReportRequester")

    @@unique([email])
    @@unique([username])
    @@map("user")
}

model Session {
    id        String   @id @default(cuid())
    expiresAt DateTime
    ipAddress String?
    userAgent String?
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    impersonatedBy String?

    activeOrganizationId String?

    token     String
    createdAt DateTime
    updatedAt DateTime

    @@unique([token])
    @@map("session")
}

model Account {
    id           String    @id @default(cuid())
    accountId    String
    providerId   String
    userId       String
    user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken  String?   @db.Text
    refreshToken String?   @db.Text
    idToken      String?   @db.Text
    expiresAt    DateTime?
    password     String?

    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    createdAt             DateTime
    updatedAt             DateTime

    @@map("account")
}

model Verification {
    id         String   @id @default(cuid())
    identifier String
    value      String   @db.Text
    expiresAt  DateTime

    createdAt DateTime?
    updatedAt DateTime?

    @@map("verification")
}

model Passkey {
    id           String    @id @default(cuid())
    name         String?
    publicKey    String
    userId       String
    user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    credentialID String
    counter      Int
    deviceType   String
    backedUp     Boolean
    transports   String?
    createdAt    DateTime?

    @@map("passkey")
}

model TwoFactor {
    id          String @id @default(cuid())
    secret      String
    backupCodes String
    userId      String
    user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("twoFactor")
}

model Organization {
    id                 String       @id @default(cuid())
    name               String
    slug               String?
    logo               String?
    createdAt          DateTime
    metadata           String?
    paymentsCustomerId String?
    members            Member[]
    invitations        Invitation[]
    purchases          Purchase[]
    aiChats            AiChat[]
    
    // PipeTrak relations
    projects           Project[]
    
    // Reporting relations
    rocConfigurations  ROCConfigurations[]

    @@unique([slug])
    @@map("organization")
}

model Member {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    userId         String
    user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    role           String
    createdAt      DateTime

    @@unique([organizationId, userId])
    @@map("member")
}

model Invitation {
    id             String       @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    email          String
    role           String?
    status         String
    expiresAt      DateTime
    inviterId      String
    user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

    @@map("invitation")
}

enum PurchaseType {
    SUBSCRIPTION
    ONE_TIME
}

model Purchase {
    id             String        @id @default(cuid())
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    organizationId String?
    user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId         String?
    type           PurchaseType
    customerId     String
    subscriptionId String?       @unique
    productId      String
    status         String?
    createdAt      DateTime      @default(now())
    updatedAt      DateTime      @updatedAt

    @@index([subscriptionId])
    @@map("purchase")
}

model AiChat {
    id             String        @id @default(cuid())
    organizationId String?
    organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    userId         String?
    user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
    title          String?
    /// [Array<{role: "user" | "assistant"; content: string;}>]
    messages       Json          @default("[]") /// @zod.custom.use(z.array(z.object({ role: z.enum(['user', 'assistant']), content: z.string() })))
    createdAt      DateTime      @default(now())
    updatedAt      DateTime      @updatedAt

    @@map("ai_chat")
}

// PipeTrak Extensions

enum ProjectStatus {
    ACTIVE
    COMPLETED
    ARCHIVED
}

enum WorkflowType {
    MILESTONE_DISCRETE    // Checkbox milestones
    MILESTONE_PERCENTAGE  // Percentage entry milestones  
    MILESTONE_QUANTITY    // Quantity entry milestones
}

enum ComponentStatus {
    NOT_STARTED
    IN_PROGRESS
    COMPLETED
    ON_HOLD
    DELETED
}

enum ComponentType {
    // Piping Components
    SPOOL
    PIPING_FOOTAGE
    THREADED_PIPE
    FITTING         // NEW: Pipe fittings (elbows, tees, reducers, etc.)
    
    // Mechanical Components  
    VALVE
    FLANGE          // NEW: Flanges (weld neck, slip-on, blind, etc.)
    GASKET
    SUPPORT
    
    // Field Work
    FIELD_WELD
    
    // Instrumentation
    INSTRUMENT
    
    // Secondary Systems
    INSULATION
    PAINT
    
    // Generic fallback
    OTHER
}

enum ImportStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    CANCELLED
}

enum AuditAction {
    CREATE
    UPDATE  
    DELETE
    HARD_DELETE
    SOFT_DELETE
    IMPORT
    BULK_MILESTONE_UPDATE
    CONFLICT_RESOLVED
}

model Project {
    id             String   @id @default(cuid())
    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    
    // RENAMED: name â†’ jobName
    jobName        String   // Renamed from 'name'
    // NEW: jobNumber field with constraints
    jobNumber      String   @db.VarChar(10) // Max 10 characters for job numbers
    description    String?
    status         ProjectStatus @default(ACTIVE)
    
    // Metadata
    client         String?  // Client name for the project
    location       String?
    startDate      DateTime?
    targetDate     DateTime?
    
    // Audit fields
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
    createdBy      String
    creator        User @relation("ProjectCreator", fields: [createdBy], references: [id])
    
    // Relations
    drawings       Drawing[]
    components     Component[]
    milestoneTemplates MilestoneTemplate[]
    importJobs     ImportJob[]
    auditLogs      AuditLog[]
    
    // Reporting relations
    reportingCache    ReportingCache[]
    rocConfigurations ROCConfigurations[]
    progressSnapshots ProgressSnapshots[]
    reportGenerations ReportGenerations[]
    
    // QC relations
    welders           Welder[]
    fieldWelds        FieldWeld[]
    
    // UPDATED: Indexes for performance and constraints
    @@unique([organizationId, jobNumber], name: "unique_org_job_number")
    @@index([organizationId], name: "idx_project_organization")
    @@index([organizationId, status], name: "idx_project_org_status")
    @@index([jobNumber], name: "idx_project_job_number") // For cross-org job number searches
}

model Drawing {
    id          String   @id @default(cuid())
    projectId   String
    project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // Drawing identification
    number      String   // e.g., "P&ID-001"
    title       String
    revision    String?
    
    // Hierarchy support
    parentId    String?
    parent      Drawing? @relation("DrawingHierarchy", fields: [parentId], references: [id])
    children    Drawing[] @relation("DrawingHierarchy")
    
    // File references
    filePath    String?
    fileUrl     String?
    
    // Audit fields
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    // Relations  
    components  Component[]
    fieldWelds  FieldWeld[]
    
    @@unique([projectId, number])
    @@index([projectId, parentId])
}

model MilestoneTemplate {
    id          String   @id @default(cuid())
    projectId   String
    project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // Template identification
    name        String   // e.g., "Full", "Reduced", "Insulation"
    description String?
    
    // Milestone definitions (JSON array)
    /// [Array<{name: string, weight: number, order: number}>]
    milestones  Json     /// @zod.custom.use(z.array(z.object({ name: z.string(), weight: z.number(), order: z.number() })))
    
    // Usage tracking
    isDefault   Boolean  @default(false)
    usageCount  Int      @default(0)
    
    // Audit fields
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    // Relations
    components  Component[]
    
    @@unique([projectId, name])
    @@index([projectId, isDefault])
}

model Component {
    id                 String   @id @default(cuid())
    projectId          String
    project            Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    drawingId          String   // Required - components must belong to a drawing
    drawing            Drawing  @relation(fields: [drawingId], references: [id])
    milestoneTemplateId String
    milestoneTemplate  MilestoneTemplate @relation(fields: [milestoneTemplateId], references: [id])
    
    // Component identification
    componentId        String   // Business ID from Excel (part number)
    weldId             String?  @unique // Weld ID for FIELD_WELD components only (links to FieldWeld.weldIdNumber)
    instanceNumber     Int      @default(1) // Instance number on this drawing (1, 2, 3...)
    totalInstancesOnDrawing Int? // Total instances of this component on this drawing
    displayId          String?  // Generated: "GSWAZ1DZZASG5331-1" or "GSWAZ1DZZASG5331 (1 of 3)"
    type              ComponentType   // Component type enum
    workflowType      WorkflowType
    
    // Physical attributes
    spec              String?
    size              String?
    material          String?
    pressureRating    String?
    description       String?
    
    // Organizational attributes
    area              String?
    system            String?
    testPackage       String?
    testPressure      Float?
    testRequired      String?
    
    // Quantity fields (for milestone_quantity workflow)
    totalLength       Float?
    lengthUnit        String?  // "ft", "m", etc.
    totalQuantity     Float?
    quantityUnit      String?
    
    // Import notes (comments from Excel)
    notes             String?
    
    // Calculated progress
    completionPercent Float    @default(0) // 0-100
    
    // Status tracking
    status            ComponentStatus @default(NOT_STARTED)
    
    // Audit fields  
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt
    installationDate  DateTime?
    installerUserId   String?
    installer         User?    @relation("ComponentInstaller", fields: [installerUserId], references: [id])
    
    // Relations
    milestones        ComponentMilestone[]
    auditLogs         AuditLog[]
    fieldWelds        FieldWeld[]  // Field welds linked by weldId
    
    // Unique constraint per drawing (not project)
    @@unique([drawingId, componentId, instanceNumber])
    
    // Indexes for querying
    @@index([drawingId, componentId]) // All instances of a component on a drawing
    @@index([projectId, componentId]) // All instances across project
    @@index([projectId, drawingId])
    @@index([projectId, type])
    @@index([projectId, area])
    @@index([projectId, system]) 
    @@index([projectId, testPackage])
    @@index([projectId, status])
    @@index([projectId, workflowType])
    @@index([weldId]) // For field weld lookups
    // Composite index for common filtering patterns
    @@index([projectId, area, system, type, status])
}

model ComponentMilestone {
    id          String   @id @default(cuid())
    componentId String
    component   Component @relation(fields: [componentId], references: [id], onDelete: Cascade)
    
    // Milestone identification (from template)
    milestoneName String  // e.g., "Receive", "Erect", "Connect"
    milestoneOrder Int    // Order within template
    weight        Float   // ROC weight (0-100)
    
    // Completion tracking
    isCompleted   Boolean @default(false)
    
    // Workflow-specific fields
    percentageValue Float?  // For milestone_percentage
    quantityValue   Float?  // For milestone_quantity
    quantityUnit    String? // For milestone_quantity
    
    // Audit fields
    completedAt   DateTime?
    completedBy   String?
    completer     User?    @relation("MilestoneCompleter", fields: [completedBy], references: [id])
    effectiveDate DateTime @default(now()) @db.Date // Date when work was actually completed (for backdating)
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
    
    @@unique([componentId, milestoneName])
    @@index([componentId, milestoneOrder])
    @@index([componentId, isCompleted])
    @@index([effectiveDate])
    @@index([componentId, effectiveDate])
}

model ImportJob {
    id        String   @id @default(cuid())
    projectId String
    project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    userId    String
    user      User     @relation("ImportJobUser", fields: [userId], references: [id])
    
    // Job details
    filename       String
    originalPath   String?
    status         ImportStatus @default(PENDING)
    
    // Processing results
    totalRows      Int?
    processedRows  Int?
    errorRows      Int?
    
    // Error tracking (JSON array)
    /// [Array<{row: number, field: string, error: string, value: any}>]
    errors         Json?    /// @zod.custom.use(z.array(z.object({ row: z.number(), field: z.string(), error: z.string(), value: z.any() })))
    
    // Performance tracking
    startedAt      DateTime?
    completedAt    DateTime?
    duration       Int?     // seconds
    
    // Audit fields
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
    
    @@index([projectId, status])
    @@index([userId, createdAt])
}

model AuditLog {
    id        String   @id @default(cuid())
    projectId String
    project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    userId    String
    user      User     @relation("AuditLogUser", fields: [userId], references: [id])
    
    // Component relation (optional - only when entityType is "Component")
    componentId   String?
    component     Component? @relation(fields: [componentId], references: [id], onDelete: Cascade)
    
    // Record identification
    entityType    String  // "Component", "ComponentMilestone", etc.
    entityId      String  // ID of the changed record
    action        AuditAction
    
    // Change tracking (JSON)
    /// {[field: string]: {old: any, new: any}}
    changes       Json    /// @zod.custom.use(z.record(z.object({ old: z.any(), new: z.any() })))
    
    // Context
    ipAddress     String?
    userAgent     String?
    sessionId     String?
    
    // Audit fields
    timestamp     DateTime @default(now())
    
    @@index([projectId, entityType, entityId])
    @@index([projectId, userId, timestamp])
    @@index([projectId, timestamp])
}

// Reporting Infrastructure Models

enum ReportType {
    PROGRESS_SUMMARY
    COMPONENT_DETAILS
    TEST_READINESS
    TREND_ANALYSIS
    AUDIT_TRAIL
}

enum ReportStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
}

enum OutputFormat {
    JSON
    CSV
    EXCEL
    PDF
}

enum DeliveryMethod {
    DOWNLOAD
    EMAIL
    API
}

enum GenerationMethod {
    MANUAL
    SCHEDULED
    REALTIME
}

model ReportingCache {
    id                   String   @id @default(cuid())
    projectId            String
    project              Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // Cache details
    reportType           String   // ReportType enum values
    cacheKey             String   // Hash of filter parameters
    filters              Json     @default("{}") /// @zod.custom.use(z.record(z.any()))
    result               Json     @default("{}") /// @zod.custom.use(z.any())
    
    // Cache metadata
    calculatedAt         DateTime @default(now())
    expiresAt            DateTime // Default: NOW() + 5 minutes
    calculationDuration  Int?     // Milliseconds for performance tracking
    rowCount             Int?     // Number of records in result
    createdBy            String?
    creator              User?    @relation("CacheCreator", fields: [createdBy], references: [id])
    
    @@unique([projectId, reportType, cacheKey], name: "idx_cache_unique")
    @@index([expiresAt], name: "idx_cache_expiry")
    @@index([projectId, reportType], name: "idx_cache_project_type")
    @@index([calculatedAt], name: "idx_cache_calculated")
}

model ROCConfigurations {
    id                String   @id @default(cuid())
    organizationId    String
    organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
    projectId         String?  // NULL = org default
    project           Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // Configuration details
    componentType     String?  // NULL = applies to all types
    milestoneWeights  Json     @default("{\"Receive\": 10, \"Erect\": 30, \"Connect\": 40, \"Test\": 15, \"Complete\": 5}") /// @zod.custom.use(z.record(z.number()))
    description       String?
    isDefault         Boolean  @default(false)
    effectiveDate     DateTime @default(now())
    
    // Audit fields
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt
    createdBy         String
    creator           User     @relation("ROCConfigCreator", fields: [createdBy], references: [id])
    
    // Relations
    progressSnapshots ProgressSnapshots[]
    
    @@index([organizationId, projectId], name: "idx_roc_org_project")
    @@index([organizationId, effectiveDate], name: "idx_roc_effective")
    @@index([organizationId, componentType], name: "idx_roc_component_type")
    // Note: Conditional unique constraints are not supported in Prisma
    // This constraint is enforced at the database level via migration
}

model ProgressSnapshots {
    id                      String   @id @default(cuid())
    projectId               String
    project                 Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // Snapshot timing
    snapshotDate            DateTime @db.Date // Date only for uniqueness
    snapshotTime            DateTime @default(now()) // Full timestamp
    
    // Aggregated metrics
    totalComponents         Int      @default(0)
    completedComponents     Int      @default(0)
    overallCompletionPercent Decimal @default(0.00) @db.Decimal(5,2)
    rocWeightedPercent      Decimal  @default(0.00) @db.Decimal(5,2)
    
    // Breakdown data (JSON arrays)
    areaBreakdown           Json     @default("[]") /// @zod.custom.use(z.array(z.object({ area: z.string(), completionPercent: z.number(), componentCount: z.number() })))
    systemBreakdown         Json     @default("[]") /// @zod.custom.use(z.array(z.object({ system: z.string(), completionPercent: z.number(), componentCount: z.number() })))
    testPackageBreakdown    Json     @default("[]") /// @zod.custom.use(z.array(z.object({ testPackage: z.string(), completionPercent: z.number(), componentCount: z.number(), isReady: z.boolean() })))
    
    // Velocity metrics
    dailyVelocity           Decimal? @db.Decimal(8,2) // Components completed per day
    weeklyVelocity          Decimal? @db.Decimal(8,2) // Components completed per week
    milestoneVelocity       Json     @default("{}") /// @zod.custom.use(z.record(z.number()))
    
    // Quality metrics
    stalledComponents7d     Int      @default(0)
    stalledComponents14d    Int      @default(0)
    stalledComponents21d    Int      @default(0)
    
    // Generation metadata
    calculationDuration     Int?     // Milliseconds
    generatedBy             String?
    generator               User?    @relation("SnapshotGenerator", fields: [generatedBy], references: [id])
    generationMethod        String   @default("SCHEDULED") // GenerationMethod enum values
    
    // ROC configuration used
    rocConfigId             String?
    rocConfig               ROCConfigurations? @relation(fields: [rocConfigId], references: [id], onDelete: SetNull)
    
    @@unique([projectId, snapshotDate], name: "idx_snapshot_project_date")
    @@index([snapshotTime], name: "idx_snapshot_time")
    @@index([projectId, snapshotTime], name: "idx_snapshot_project_time")
}

model ReportGenerations {
    id               String    @id @default(cuid())
    projectId        String
    project          Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // Request details
    reportType       String    // ReportType enum values
    requestedBy      String
    requester        User      @relation("ReportRequester", fields: [requestedBy], references: [id])
    requestedAt      DateTime  @default(now())
    
    // Request configuration
    filters          Json      @default("{}") /// @zod.custom.use(z.record(z.any()))
    outputFormat     String    // OutputFormat enum values
    deliveryMethod   String    @default("DOWNLOAD") // DeliveryMethod enum values
    
    // Processing details
    status           String    @default("PENDING") // ReportStatus enum values
    startedAt        DateTime?
    completedAt      DateTime?
    duration         Int?      // Milliseconds
    
    // Results
    resultRowCount   Int?
    resultSize       BigInt?   // Bytes
    downloadUrl      String?   // Supabase Storage signed URL
    downloadExpires  DateTime?
    
    // Error tracking
    errorMessage     String?
    errorDetails     Json?     /// @zod.custom.use(z.any())
    
    // Performance metadata
    cacheHit         Boolean   @default(false)
    dbQueryTime      Int?      // Milliseconds
    exportTime       Int?      // Milliseconds
    memoryUsage      BigInt?   // Bytes peak usage
    
    @@index([requestedBy, requestedAt], name: "idx_report_gen_user")
    @@index([projectId, requestedAt], name: "idx_report_gen_project")
    @@index([status, requestedAt], name: "idx_report_gen_status")
    @@index([reportType, requestedAt], name: "idx_report_gen_type")
}

// ============================================================================
// QC MODELS - Field Weld Quality Control System
// ============================================================================

model WeldType {
    id          String      @id @default(cuid())
    code        String      @unique  // BW, SW, FW, etc.
    description String                // "Butt Weld", "Socket Weld", etc.
    active      Boolean     @default(true)
    createdAt   DateTime    @default(now())
    
    fieldWelds  FieldWeld[]
    
    @@map("weld_type")
}

model Welder {
    id          String      @id @default(cuid())
    projectId   String
    project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // Identification
    stencil     String      // Unique welder identifier/stamp
    name        String      // Full welder name
    active      Boolean     @default(true)
    
    // Audit fields
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt
    
    // Relations
    fieldWelds  FieldWeld[]
    
    @@unique([projectId, stencil], name: "idx_welder_project_stencil")
    @@index([projectId, active], name: "idx_welder_project_active")
    @@map("welder")
}

model FieldWeld {
    id          String      @id @default(cuid())
    projectId   String
    project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // Core identification
    weldIdNumber    String      // QC-assigned, unique per project
    welderId        String?
    welder          Welder?     @relation(fields: [welderId], references: [id])
    dateWelded      DateTime?
    
    // Drawing inheritance
    drawingId       String
    drawing         Drawing     @relation(fields: [drawingId], references: [id])
    packageNumber   String      // Auto-inherited from drawing
    testPressure    Json        @default("{}") // Auto-inherited {value, unit}
    specCode        String      // Auto-inherited from drawing
    
    // Optional tie-in reference
    tieInNumber     String?     // Tie-in identifier if applicable
    
    // Weld specifications
    xrayPercent     Int?        // X-RAY % (0-100 or null)
    weldSize        String      // Nominal size: "6", "12x4", "DN150"
    schedule        String      // Pipe wall schedule: "40", "80", "STD", "XS"
    weldTypeCode    String      // FK to WeldType
    weldType        WeldType    @relation(fields: [weldTypeCode], references: [code])
    baseMetal       String?     // Material(s) joined: "A106 Gr B", "304L"
    
    // Post-weld heat treatment
    pwhtRequired    Boolean     @default(false)
    datePwht        DateTime?   // Date PWHT completed
    
    // NDE tracking
    ndeTypes        String[]    @default([]) // ["RT", "UT", "PT", "MT", "VT"]
    ndeResult       String?     // "Accept", "Reject", "Repair", "Pending"
    ndeDate         DateTime?   // Date of NDE
    
    // Turnover
    turnoverDate    DateTime?   // Date turned over to client
    comments        String?     @db.Text // Free text notes, max 1000 chars
    
    // Link to component via weldId for milestone tracking  
    component       Component?  @relation(fields: [weldIdNumber], references: [weldId])
    
    // Audit fields
    createdAt       DateTime    @default(now())
    updatedAt       DateTime    @updatedAt
    
    @@unique([projectId, weldIdNumber], name: "idx_field_weld_project_id")
    @@index([weldIdNumber], name: "idx_field_weld_id") // For component relationship
    @@index([projectId, packageNumber], name: "idx_field_weld_package")
    @@index([projectId, welderId], name: "idx_field_weld_welder")
    @@index([projectId, drawingId], name: "idx_field_weld_drawing")
    @@index([projectId, ndeResult], name: "idx_field_weld_nde")
    @@index([projectId, pwhtRequired], name: "idx_field_weld_pwht")
    @@map("field_weld")
}

// Early access leads for marketing/landing page
model EarlyAccessLead {
    id            String   @id @default(uuid())
    name          String
    email         String   @unique
    company       String
    projectSize   String   // "small", "medium", "large", "enterprise" 
    currentMethod String   // "excel", "paper", "other_software", "none"
    role          String
    phone         String?
    message       String?  @db.Text
    source        String   @default("landing_page")
    utmSource     String?
    utmMedium     String?
    utmCampaign   String?
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    @@index([email])
    @@index([createdAt])
    @@index([company])
    @@index([projectSize])
    @@map("EarlyAccessLead")
}
